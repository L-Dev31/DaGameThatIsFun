<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Party Game Lobby</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/mobile_style.css">
  <link rel="stylesheet" href="/static/lobby_style.css">
  <link rel="icon" type="image/png" href="/static/images/favicon/favicon.png">
</head>
<body>
  <!-- Contrôles généraux -->
  <button class="share-control" id="shareToggle">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30" width="24px" fill="white" height="24px">
      <path d="M23 3A4 4 0 0 0 19 7A4 4 0 0 0 19.09 7.84L10.01 12.38A4 4 0 0 0 7 11A4 4 0 0 0 3 15A4 4 0 0 0 7 19A4 4 0 0 0 10.01 17.63L19.09 22.16A4 4 0 0 0 19 23A4 4 0 0 0 23 27A4 4 0 0 0 27 23A4 4 0 0 0 23 19A4 4 0 0 0 19.99 20.38L10.91 15.84A4 4 0 0 0 11 15Z"/>
    </svg>
  </button>
  <button class="sound-control" id="soundToggle">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
      <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
      <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
    </svg>
  </button>
  <div id="qrCodeModal" class="modal-overlay">
    <div class="modal-container">
      <h2 class="modal-title">Partager le lien</h2>
      <div class="modal-content">
        <p id="qrCodeUrl" style="word-break: break-all; margin-bottom: 1rem;"></p>
        <img id="qrCodeImage" alt="QR Code" style="width: 200px; height: 200px; margin: 0 auto;">
        <div style="margin-top: 1rem; text-align: center;">
          <button onclick="copyLink()" class="modal-button modal-button-secondary">Copier le lien</button>
        </div>
      </div>
      <div class="modal-buttons">
        <button class="modal-button modal-button-primary" onclick="hideModal('qrCodeModal')">Fermer</button>
      </div>
    </div>
  </div>
  <div class="bg"></div>
  <!-- Intro et logo -->
  <div id="introScreen" class="intro-screen">
    <div class="intro-content">
      <img src="/static/images/logo/logo.png" alt="Party Game Logo" class="intro-logo">
      <p class="intro-text">Avertissement !</p>
    </div>
    <div class="security-text">
      Veuillez noter que ce jeu peut contenir du contenu grossier ou inapproprié pour certains publics.<br><br>
      Ce n’est en aucun cas notre intention de blesser quiconque, il s’agit simplement d’un jeu conçu pour s’amuser et rire ensemble :)
    </div>
  </div>
  <div class="logo-container">
    <img src="/static/images/logo/logo.png" alt="Party Game Logo" class="logo">
  </div>
  <!-- Zone principale -->
  <div class="container">
    <div class="grid">
      <div>
        <div class="game-buttons">
          <button class="game-button active" data-game="draw-contest">
            <img src="/static/images/logo/draw-contest.png" alt="Draw Contest" class="game-logo">
          </button>
          <button class="game-button" data-game="pictionary">
            <img src="/static/images/logo/pictionary.png" alt="Pictionary" class="game-logo">
          </button>
          <button class="game-button" data-game="quiz-rush">
            <img src="/static/images/logo/quiz-rush.png" alt="Quiz Rush" class="game-logo">
          </button>
          <button class="game-button" data-game="object-tales" disabled>
            <img src="/static/images/logo/object-tales-disabled.png" alt="Object Tales" class="game-logo">
          </button>
        </div>
      </div>
      <div class="preview-card">
        <div class="tv-static"></div>
        <img src="/static/images/preview/draw-contest.png" alt="Game Preview" class="preview-image" id="previewImage">
        <div class="preview-content">
          <h3 class="preview-title" id="previewTitle">Dessine moi un Désastre</h3>
          <p class="preview-description" id="previewDescription">
            Une phrase loufoque, des dessins absurdes, et un vote pour élire l'œuvre la plus iconique. À vos pinceaux, le massacre commence !
          </p>
          <p class="preview-player-number" id="previewPlayerNumber">4-8 Joueurs</p>
          <button class="preview-button">Lancer le jeu !</button>
        </div>
      </div>
    </div>
    <!-- Boutons du bas affichés dynamiquement -->
    <div class="bottom-actions" id="bottomActions"></div>
  </div>
  <div id="playersContainer" class="players-container" style="display:none;"></div>
  <audio id="staticSound" src="/static/music/tv-static.mp3"></audio>
  <!-- Chargement des modules -->
  <script type="module" src="javascript/lobby_redirection.js"></script>
  <script type="module" src="javascript/index.js"></script>
  <script type="module">
    import LobbyManager from './javascript/lobby_manager.js';

    async function loadBottomButtons() {
      try {
        const response = await fetch('button_config.json');
        const config = await response.json();
        const bottomActions = document.getElementById('bottomActions');
        const inLobby = localStorage.getItem('roomCode') ? true : false;
        console.log(`[INDEX] Mode ${inLobby ? "EN LOBBY" : "HORS LOBBY"} – chargement de la configuration des boutons.`);
        const buttons = inLobby ? config.inLobby : config.outLobby;
        bottomActions.innerHTML = '';
        buttons.forEach(btn => {
          const a = document.createElement('a');
          if (btn.link) {
            a.href = btn.link;
          }
          const button = document.createElement('button');
          button.className = 'action-button';
          if (btn.action) button.classList.add(btn.action);
          button.innerHTML = btn.icon + btn.title;
          button.addEventListener('click', async (e) => {
            e.preventDefault();
            console.log(`[INDEX] Bouton cliqué: ${btn.title}`);
            if (inLobby) {
              if (btn.action === 'quit') {
                if (confirm("Êtes-vous sûr de vouloir quitter le lobby ?")) {
                  console.log("[INDEX] Quitter le lobby demandé.");
                  await LobbyManager.leaveLobby();
                  localStorage.removeItem('roomCode');
                  window.location.href = 'index.html';
                }
              } else if (btn.action === 'credits') {
                const lobby = await LobbyManager.getCurrentLobby();
                if (lobby && lobby.isOwner) {
                  console.log("[INDEX] Owner quittant le lobby pour accéder aux Credits.");
                  await LobbyManager.sendCommandToPlayers('lobby-deleted');
                  await LobbyManager.leaveLobby();
                  window.location.href = 'credits.html';
                } else {
                  console.log("[INDEX] Redirection automatique vers Credits pour non-owner.");
                  automaticRedirect('credits.html');
                }
              } else if (btn.action === 'add_players') {
                console.log("[INDEX] Owner envoie une commande pour que tout le monde aille en salle d'attente.");
                await LobbyManager.sendCommandToPlayers('redirect', { url: 'waiting_room.html' });
                window.location.href = 'waiting_room.html';
              } else if (btn.link) {
                console.log(`[INDEX] Redirection vers ${btn.link}`);
                window.location.href = btn.link;
              }
            } else {
              if (btn.link) {
                console.log(`[INDEX] Redirection vers ${btn.link} (mode hors lobby)`);
                window.location.href = btn.link;
              }
            }
          });
          a.appendChild(button);
          bottomActions.appendChild(a);
        });
      } catch (error) {
        console.error("[INDEX] Erreur lors du chargement des boutons:", error);
      }
    }

    LobbyManager.init();
    loadBottomButtons();
  </script>
</body>
</html>
